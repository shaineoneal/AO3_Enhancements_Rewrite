(()=>{"use strict";const e=(...e)=>{console.log(...e)};class t{constructor(e,t,r,o,n,s,a,i,c,l,d,u){this.workId=e,this.title=t,this.author=r,this.fandoms=o,this.relationships=n,this.tags=s,this.description=a,this.wordCount=i,this.totalChapters=c,this.status=l,this.rating=d,this.rereadCount=u}toString(){return JSON.stringify(this)}}class r extends t{static getWorkFromPage(e){var t;const r=document.querySelector(`#work_${e}`);if(!r)throw new Error(`Work ${e} not found on page`);const o=r.querySelector(".heading > a").textContent,n=r.querySelectorAll("[rel='author']"),s=Array.from(n).map((e=>e.textContent)),a=r.querySelectorAll(".fandoms > a"),i=Array.from(a).map((e=>e.textContent)),c=r.querySelector("dd.words").textContent;var l=null===(t=r.querySelector("dd.chapters > a"))||void 0===t?void 0:t.textContent;return l||(l="1"),new this(e,o,s,i,["placeholder"],["placeholder"],"longer placeholder",parseInt(c.replace(/,/g,"")),parseInt(l.replace(/,/g,"")),"",0,0)}static createWork(e){var t;if(!e)throw new Error("Work not found on page");const r=parseInt(e.id.split("_")[1]),o=e.querySelector(".heading > a").textContent,n=e.querySelectorAll("[rel='author']"),s=Array.from(n).map((e=>e.textContent)),a=e.querySelectorAll(".fandoms > a"),i=Array.from(a).map((e=>e.textContent)),c=e.querySelectorAll(".relationships > a"),l=Array.from(c).map((e=>e.textContent)),d=e.querySelectorAll(".warnings > a, .characters > a, .freeforms > a"),u=Array.from(d).map((e=>e.textContent)),p=e.querySelector(".summary > p").textContent,h=e.querySelector("dd.words").textContent;var m=null===(t=e.querySelector("dd.chapters > a"))||void 0===t?void 0:t.textContent;return m||(m="1"),new this(r,o,s,i,l,u,p,parseInt(h.replace(/,/g,"")),parseInt(m.replace(/,/g,"")),"",0,0)}}var o=function(e,t,r,o){return new(r||(r=Promise))((function(n,s){function a(e){try{c(o.next(e))}catch(e){s(e)}}function i(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,i)}c((o=o.apply(e,t||[])).next())}))};e("log: content_script.tsx loaded"),function(){return o(this,void 0,void 0,(function*(){const t=yield chrome.runtime.connect({name:"content_script"});return e("port: ",t),t}))}().then((t=>{(function(t){return o(this,void 0,void 0,(function*(){const r=new Promise((r=>{t.postMessage({message:"getAuthToken"}),t.onMessage.addListener((t=>{e("content_script","port.onMessage: ",t),t.token&&(e("resolved token: ",t.token),r(t.token)),t.error&&(e("error: ",t.error),r(""))}))}));e("token check: ",r),r.then((t=>(e("token: ",t),t))).catch((t=>(e("error: ",t),"")))}))})(t).then((n=>{e("token: ",n),function(t){o(this,void 0,void 0,(function*(){document.querySelector(".index.group.work")?(t=>{const o=document.querySelector("li.work, li.bookmark");e("port test: ",t),e("temp style: ",getComputedStyle(o)),e("temp style: ",JSON.stringify(getComputedStyle(o)));const n=Array.from(document.querySelectorAll("li.work, li.bookmark"));var s=new Array;n.forEach((t=>{var o,n,a=document.createElement("div");a.classList.add("blurb-with-toggles"),a.style.cssText=JSON.stringify(getComputedStyle(t)),n=a,(o=t).parentNode.insertBefore(n,o),n.appendChild(o),function(t){const o=t.firstChild,n=document.createElement("a");n.textContent="Add Work",n.className="toggle",n.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),e("blurbToggle clicked!: ",o),chrome.runtime.sendMessage({message:"addWorkToSheet",work:r.createWork(o)}),o.classList.add("read-work")})),e("blurbToggles: ",o);const s=o.cloneNode(!1);s.className="blurb-toggle",s.removeAttribute("id"),s.removeAttribute("role"),s.appendChild(n),t.insertBefore(s,t.firstChild)}(a),t.classList.contains("bookmark")?s.push(t.classList[3].split("-")[1]):s.push(t.id.split("_")[1])})),e("searchList: ",s),e("work: ",r.getWorkFromPage(s[0])),t.postMessage({message:"querySheet",list:s}),t.onMessage.addListener((t=>{e("content_script","port.onMessage: ",t),"querySheet"===t.reason&&t.response&&t.response.forEach(((t,r)=>{e("workRef: ",t),t&&n[r].classList.add("read-work")}))}))})(t):document.querySelector(".work.meta.group")?(t=>{const r=location.href.split("/")[4];e("insideWork workId: ",r),t.postMessage({message:"querySheet",work:r}),t.onMessage.addListener((t=>{e("insideWork","port.onMessage: ",t),"workQuerySheet"===t.reason&&t.response&&(e("workRef: ",t.response),t.response&&document.querySelector("dl.work.meta.group").classList.add("read-work"))}))})(t):e("PANIK: Unknown page")}))}(t)}))}))})();