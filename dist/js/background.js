(()=>{"use strict";const e=(...e)=>{console.log(...e)};var t=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{d(r.next(e))}catch(e){s(e)}}function i(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}d((r=r.apply(e,t||[])).next())}))};function n(){return t(this,void 0,void 0,(function*(){return new Promise(((t,n)=>{chrome.cookies.get({name:"authToken",url:"https://archiveofourown.org"},(r=>{r?(e("cookie.value: ",r.value),t(r.value)):n("Error getting token")}))}))}))}var r=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{d(r.next(e))}catch(e){s(e)}}function i(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}d((r=r.apply(e,t||[])).next())}))};function o(){return e("getting spreadsheet URL"),new Promise(((t,o)=>{chrome.storage.sync.get(["spreadsheetUrl"],(s=>r(this,void 0,void 0,(function*(){e("fetchSpreadSheetUrl result: ",s);const a=s.spreadsheetUrl;if(e("spreadsheetUrl type: ",typeof a),void 0!==a&&0!==Object.keys(a).length)e("user has spreadsheet URL: ",a),e("spreadsheetID: ",String(a).split("/")[5]),t(a);else{e("user doesn't have spreadsheet URL, creating spreadsheet");const s=yield n();null===s?o("Error getting token"):yield function(t){return r(this,void 0,void 0,(function*(){const n={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+t},body:JSON.stringify({properties:{title:"AO3E"},namedRanges:[{namedRangeId:"0",name:"WorkID",range:{sheetId:0,startColumnIndex:0,endColumnIndex:1}},{namedRangeId:"1",name:"title",range:{sheetId:0,startColumnIndex:1,endColumnIndex:2}},{namedRangeId:"2",name:"authors",range:{sheetId:0,startColumnIndex:2,endColumnIndex:3}},{namedRangeId:"3",name:"fandoms",range:{sheetId:0,startColumnIndex:3,endColumnIndex:4}},{namedRangeId:"4",name:"relationships",range:{sheetId:0,startColumnIndex:4,endColumnIndex:5}},{namedRangeId:"5",name:"tags",range:{sheetId:0,startColumnIndex:5,endColumnIndex:6}},{namedRangeId:"6",name:"description",range:{sheetId:0,startColumnIndex:6,endColumnIndex:7}},{namedRangeId:"7",name:"wordCount",range:{sheetId:0,startColumnIndex:7,endColumnIndex:8}},{namedRangeId:"8",name:"chapterCount",range:{sheetId:0,startColumnIndex:8,endColumnIndex:9}},{namedRangeId:"9",name:"status",range:{sheetId:0,startColumnIndex:9,endColumnIndex:10}},{namedRangeId:"10",name:"rating",range:{sheetId:0,startColumnIndex:10,endColumnIndex:11}}],sheets:{properties:{title:"Saved Works",sheetId:0},protectedRanges:[{protectedRangeId:0,range:{},description:"Protected",warningOnly:!0}],data:[{startRow:0,startColumn:0,rowData:[{values:[{userEnteredValue:{stringValue:"Work ID"},userEnteredFormat:{textFormat:{bold:!0}}},{userEnteredValue:{stringValue:"Title"},userEnteredFormat:{textFormat:{bold:!0}}},{userEnteredValue:{stringValue:"Authors"},userEnteredFormat:{textFormat:{bold:!0}}},{userEnteredValue:{stringValue:"Fandoms"},userEnteredFormat:{textFormat:{bold:!0}}},{userEnteredValue:{stringValue:"Relationships"},userEnteredFormat:{textFormat:{bold:!0}}},{userEnteredValue:{stringValue:"Tags"},userEnteredFormat:{textFormat:{bold:!0}}},{userEnteredValue:{stringValue:"Description"},userEnteredFormat:{textFormat:{bold:!0}}},{userEnteredValue:{stringValue:"Word Count"},userEnteredFormat:{textFormat:{bold:!0}}},{userEnteredValue:{stringValue:"Chapter Count"},userEnteredFormat:{textFormat:{bold:!0}}},{userEnteredValue:{stringValue:"Status"},userEnteredFormat:{textFormat:{bold:!0}}},{userEnteredValue:{stringValue:"Rating"},userEnteredFormat:{textFormat:{bold:!0}}}]}]},{startColumn:0,columnMetadata:{pixelSize:100}},{startColumn:1,columnMetadata:{pixelSize:300}},{startColumn:2,columnMetadata:{pixelSize:200}},{startColumn:3,columnMetadata:{pixelSize:200}},{startColumn:4,columnMetadata:{pixelSize:100}},{startColumn:5,columnMetadata:{pixelSize:100}},{startColumn:6,columnMetadata:{pixelSize:100}}]}})};return e("options: ",n),fetch("https://sheets.googleapis.com/v4/spreadsheets",n).then((t=>(e("Response status:",t.status),t.json()))).then((t=>(e("Success:",t),chrome.storage.sync.set({spreadsheetUrl:t.spreadsheetUrl}),t.spreadsheetUrl))).catch((t=>{throw e("Error creating spreadsheet:",t),t}))}))}(s).then((e=>{t(e)})).catch((e=>{o(e)}))}}))))}))}const s=(t,n,r)=>{return o=void 0,s=void 0,i=function*(){e("addWorkToSheet",r);const o=yield((t,n)=>{return r=void 0,o=void 0,a=function*(){return e("getSheetId: ",t),e("getSheetId",n),fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t.split("/")[5]}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`}}).then((e=>e.json())).then((e=>e.sheets[0].properties.sheetId))},new((s=void 0)||(s=Promise))((function(e,t){function n(e){try{d(a.next(e))}catch(e){t(e)}}function i(e){try{d(a.throw(e))}catch(e){t(e)}}function d(t){var r;t.done?e(t.value):(r=t.value,r instanceof s?r:new s((function(e){e(r)}))).then(n,i)}d((a=a.apply(r,o||[])).next())}));var r,o,s,a})(t,n);return e("addWorkToSheet","sheetId",o),fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t.split("/")[5]}:batchUpdate`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({requests:[{appendDimension:{sheetId:o,dimension:"ROWS",length:1}},{appendCells:{sheetId:o,rows:[{values:[{userEnteredValue:{numberValue:r.workId}},{userEnteredValue:{stringValue:r.title}},{userEnteredValue:{stringValue:r.author.toString()},userEnteredFormat:{wrapStrategy:"WRAP"}},{userEnteredValue:{stringValue:r.fandoms.toString()},userEnteredFormat:{wrapStrategy:"WRAP"}},{userEnteredValue:{stringValue:r.relationships.toString()},userEnteredFormat:{wrapStrategy:"WRAP"}},{userEnteredValue:{stringValue:r.tags.toString()},userEnteredFormat:{wrapStrategy:"WRAP"}},{userEnteredValue:{stringValue:r.description},userEnteredFormat:{wrapStrategy:"WRAP"}},{userEnteredValue:{numberValue:r.wordCount}},{userEnteredValue:{numberValue:r.totalChapters}},{userEnteredValue:{stringValue:r.status}},{userEnteredValue:{numberValue:r.rating}}]}],fields:"*"}},{autoResizeDimensions:{dimensions:{sheetId:o,dimension:"ROWS"}}}],includeSpreadsheetInResponse:!1})}).then((e=>e.json()))},new((a=void 0)||(a=Promise))((function(e,t){function n(e){try{d(i.next(e))}catch(e){t(e)}}function r(e){try{d(i.throw(e))}catch(e){t(e)}}function d(t){var o;t.done?e(t.value):(o=t.value,o instanceof a?o:new a((function(e){e(o)}))).then(n,r)}d((i=i.apply(o,s||[])).next())}));var o,s,a,i};var a=function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{d(r.next(e))}catch(e){s(e)}}function i(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}d((r=r.apply(e,t||[])).next())}))};const i=chrome.identity.getRedirectURL(),{oauth2:d}=chrome.runtime.getManifest();if(!d)throw new Error("You need to specify oauth2 in manifest.json");const u=d.client_id,c=`https://accounts.google.com/o/oauth2/auth?${new URLSearchParams({client_id:u,response_type:"token",redirect_uri:i,scope:["https://www.googleapis.com/auth/spreadsheets"].join(" ")}).toString()}`;function l(t){return new Promise(((n,r)=>{chrome.identity.launchWebAuthFlow({url:c,interactive:t},(t=>{return o=this,s=void 0,i=function*(){e("responseUrl",t);const o=new URL(t);e("url",o);const s=new URLSearchParams(o.hash.slice(1));e("urlParams",s);const a=Object.fromEntries(s.entries());a.expires_in="43199",e("params",a);const i=a.access_token,d=yield function(t){return new Promise(((n,r)=>{chrome.cookies.set(t,(t=>{t&&e("createCookie cookie",t),n(t)}))}))}({name:"authToken",url:"https://www.archiveofourown.org/",value:i,expirationDate:Date.now()/1e3+43199,domain:".archiveofourown.org"});if(e("cookie",d),d)return n(d);r()},new((a=void 0)||(a=Promise))((function(e,t){function n(e){try{d(i.next(e))}catch(e){t(e)}}function r(e){try{d(i.throw(e))}catch(e){t(e)}}function d(t){var o;t.done?e(t.value):(o=t.value,o instanceof a?o:new a((function(e){e(o)}))).then(n,r)}d((i=i.apply(o,s||[])).next())}));var o,s,a,i}))}))}chrome.runtime.onConnect.addListener((function(t){t.onMessage.addListener((function(r){e("port message",r),"getAuthToken"===r.message?(e("getAuthToken message recieved"),n().then((n=>{e("port token",n),t.postMessage({token:n})})).catch((()=>{var n,r;e("port token","none"),chrome.scripting.executeScript({target:{tabId:(null===(r=null===(n=t.sender)||void 0===n?void 0:n.tab)||void 0===r?void 0:r.id)||0},func:()=>{window.confirm("You need an auth token! Log back in?")}}).then((n=>{e("im a genius",n),l(!0).then((n=>{var r,o;e("cookie",n),chrome.runtime.reload(),chrome.scripting.executeScript({target:{tabId:(null===(o=null===(r=t.sender)||void 0===r?void 0:r.tab)||void 0===o?void 0:o.id)||0},func:()=>{window.location.reload()}})}))}))}))):"fetchSpreadsheetUrl"===r.message?(e("fetchSpreadsheetUrl message recieved"),o().then((n=>{e("port spreadsheetUrl",n),t.postMessage({spreadsheetUrl:n})}))):"querySheet"===r.message?(e("querySheet message received, payload: ",r),r.list?n().then((n=>{e("token",n),o().then((o=>{(function(t,n,r){return a(this,void 0,void 0,(function*(){let o="select A where A matches";return r.forEach((e=>{e===r[0]?o+=` '${e}'`:o+=` or A matches '${e}'`})),encodeURIComponent(o),e("listQuery",encodeURIComponent(o)),fetch(`https://docs.google.com/spreadsheets/d/${t.split("/")[5]}/gviz/tq?tq=${encodeURIComponent(o)}&access_token=${n}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`}}).then((e=>e.text())).then((t=>{e("listQuery","res",t);const n=JSON.parse(t.substring(47,t.length-2));return e("listQuery","json",n),n}))}))})(o,n,r.list).then((n=>{e("response",n);const o=function(t,n){var r=new Array(20).fill(!1);return e("searchList",t),e("response",n),t.forEach((e=>{n.forEach((o=>{e===o.c[0].f&&(r[t.indexOf(e)]=!0,n.splice(n.indexOf(o),1))}))})),r}(r.list,n.table.rows);t.postMessage({reason:"listQuerySheet",response:o})}))}))})).catch((n=>{e("error",n),t.postMessage({reason:"listQuerySheet",response:n})})):r.work&&(e("single work querySheet message received"),n().then((n=>{e("token",n),o().then((o=>{(function(t,n,r){return a(this,void 0,void 0,(function*(){let o=`select A where A matches ${r}`;return encodeURIComponent(o),e("listQuery",encodeURIComponent(o)),fetch(`https://docs.google.com/spreadsheets/d/${t.split("/")[5]}/gviz/tq?tq=${encodeURIComponent(o)}&access_token=${n}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`}}).then((e=>e.text())).then((t=>{e("listQuery","res",t);const n=JSON.parse(t.substring(47,t.length-2));return e("listQuery","json",n),n}))}))})(o,n,r.work).then((n=>{e("response",n),t.postMessage({reason:"workQuerySheet",response:n})}))}))})).catch((n=>{e("error",n),t.postMessage({reason:"workQuerySheet",response:n})})))):"sendLoginNotification"===r.message&&e("sendLoginNotification message recieved")})),t.onDisconnect.addListener((function(){e("port disconnected")}))})),chrome.runtime.onMessage.addListener((function(t,r,a){"addWorkToSheet"===t.message&&(e("addWorkToSheet message recieved"),n().then((n=>{e("token",n),o().then((r=>{s(r,n,t.work).then((t=>{e("response",t),a({response:t})}))}))})))})),chrome.storage.onChanged.addListener((t=>{t.spreadsheetUrl&&(e("spreadsheetUrl changed",t.spreadsheetUrl),chrome.runtime.sendMessage({message:"spreadsheetUrlChanged",newUrl:t.spreadsheetUrl.newValue}))}))})();